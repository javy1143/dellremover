# ==============================================================================
# MASTER DELL BLOATWARE REMOVAL SCRIPT v5.0
# TARGETS: Peripheral Manager, Display Manager, Core Services, & Ghost Icons
# ==============================================================================

$ErrorActionPreference = "SilentlyContinue"

# 1. STOP & KILL PERIPHERAL PROCESSES
Write-Host "--- Stopping Peripheral & Display Manager Processes ---" -ForegroundColor Cyan
$KillList = @("DDPM", "DellPeripheralManager", "PeripheralCore", "dpm-service", "msiexec", "setup")
foreach ($Proc in $KillList) {
    Get-Process | Where-Object { $_.Name -like "*$Proc*" } | Stop-Process -Force
}

# 2. DISABLE SERVICES (Crucial for Peripheral Core)
Write-Host "--- Disabling Core Services ---" -ForegroundColor Cyan
$SvcList = @("DDPMService", "DellPeripheralManagerService", "PeripheralCoreService", "FusionService", "dcubsvc")
foreach ($Svc in $SvcList) {
    Set-Service -Name $Svc -StartupType Disabled
    Stop-Service -Name $Svc -Force
}

# 3. COMPREHENSIVE REGISTRY UNINSTALL (Broader Wildcards)
Write-Host "--- Uninstalling via Registry ---" -ForegroundColor Cyan
$RegPaths = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*",
    "HKCU:\Software\Microsoft\Windows\CurrentVersion\Uninstall\*"
)

# Added "Display" and "Peripheral" to the match list
$Targets = @("*Dell*Display*", "*Dell*Peripheral*", "*SupportAssist*", "*CinemaColor*", "*Dell*Pair*", "*Fusion*")

$Apps = Get-ItemProperty $RegPaths | Where-Object { 
    $DisplayName = $_.DisplayName
    foreach ($T in $Targets) { if ($DisplayName -like $T) { return $true } }
    return $false
}

foreach ($App in $Apps) {
    Write-Host "Uninstalling: $($App.DisplayName)" -ForegroundColor Yellow
    if ($App.UninstallString -match "msiexec") {
        $Guid = ([regex]::Match($App.UninstallString, '{.*}')).Value
        Start-Process "msiexec.exe" -ArgumentList "/x $Guid /qn /norestart" -Wait
    } else {
        $Cmd = $App.UninstallString -replace '/I','/X'
        Start-Process cmd.exe -ArgumentList "/c $Cmd /S /quiet /verysilent" -Wait
    }
}

# 4. TARGETED UWP REMOVAL (Peripheral Manager Store Version)
Write-Host "--- Removing Appx Packages ---" -ForegroundColor Cyan
$UWPList = @("*DellDisplayManager*", "*DellPeripheralManager*", "*DellInc*")
foreach ($Package in $UWPList) {
    Get-AppxPackage -Name $Package -AllUsers | Remove-AppxPackage -AllUsers
    Get-AppxProvisionedPackage -Online | Where-Object { $_.DisplayName -like $Package } | Remove-AppxProvisionedPackage -Online
}

# 5. SCRUB SHORTCUTS & FOLDERS
Write-Host "--- Cleaning Start Menu & Program Files ---" -ForegroundColor Cyan
$PathsToScrub = @(
    "$env:ProgramData\Microsoft\Windows\Start Menu\Programs",
    "$env:AppData\Microsoft\Windows\Start Menu\Programs",
    "$env:ProgramData\Dell",
    "$env:ProgramFiles\Dell",
    "$env:ProgramFiles (x86)\Dell"
)

foreach ($Path in $PathsToScrub) {
    if (Test-Path $Path) {
        # Delete Shortcuts
        Get-ChildItem -Path $Path -Recurse -Include "*.lnk", "*.url" | Where-Object { $_.Name -like "*Dell*" } | Remove-Item -Force
        # Force Delete Folders
        if ($Path -like "*\Dell") {
            cmd /c "takeown /f `"$Path`" /r /d y"
            cmd /c "icacls `"$Path`" /grant administrators:F /t /q"
            Remove-Item -Path $Path -Recurse -Force
        }
    }
}

# 6. REFRESH SHELL (Fixes Start Menu Visuals)
Write-Host "--- Refreshing UI ---" -ForegroundColor Green
Stop-Process -Name explorer -Force # Explorer restarts automatically

Write-Host "Script Complete. All Dell Peripheral components have been targeted." -ForegroundColor White
